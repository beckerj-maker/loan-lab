<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan Lab – Station B (Fixed vs. Variable)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD + Babel for JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js for the line chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useMemo, useEffect, useRef} = React;

    /*** Helpers ***/
    function formatUSD(x){
      try { return x.toLocaleString(undefined, {style:'currency', currency:'USD'}); }
      catch { return '$' + Number(x||0).toFixed(2); }
    }
    function clamp(x, min, max){ return Math.min(max, Math.max(min, x)); }

    // Standard amortized monthly payment
    function monthlyPayment(principal, annualRate, years){
      const n = Math.round(years*12);
      if(n <= 0) return 0;
      const i = annualRate/12;
      if(i === 0) return principal / n;
      return principal * (i) / (1 - Math.pow(1+i, -n));
    }

    // Remaining balance after m months given amortized payment
    function remainingBalance(principal, annualRate, years, payment, monthsElapsed){
      const i = annualRate/12;
      const n = Math.round(years*12);
      const m = clamp(monthsElapsed, 0, n);
      if(i === 0){
        // zero-interest: straight-line
        const paid = Math.min(payment*m, principal);
        return Math.max(0, principal - paid);
      }
      // closed-form remaining balance for amortized loan
      const pow = Math.pow(1+i, m);
      return principal*pow - payment*((pow - 1)/i);
    }

    function NumberInput({label, value, setValue, step=1, suffix=""}){
      return (
        <label className="block">
          <span className="text-sm text-gray-700">{label}</span>
          <div className="mt-1 flex items-center gap-2">
            <input type="number" value={value} step={step}
                   onChange={e=>setValue(Number(e.target.value))}
                   className="w-full md:w-56 px-3 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-black/30"/>
            {suffix && <span className="text-sm text-gray-500">{suffix}</span>}
          </div>
        </label>
      );
    }

    function Select({label, value, setValue, options}){
      return (
        <label className="block">
          <span className="text-sm text-gray-700">{label}</span>
          <select value={value} onChange={e=>setValue(e.target.value)}
                  className="mt-1 w-full md:w-56 px-3 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-black/30">
            {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
          </select>
        </label>
      );
    }

    function Card({title, children, footer}){
      return (
        <div className="bg-white border rounded-2xl shadow-sm p-5">
          {title && <h2 className="text-lg font-semibold mb-3">{title}</h2>}
          <div>{children}</div>
          {footer && <div className="mt-3 pt-3 border-t text-sm text-gray-600">{footer}</div>}
        </div>
      );
    }

    /*** Station B ***/
    function StationB(){
      // Defaults: a very “classroom typical” mortgage-like example
      const [principal, setPrincipal] = useState(200000);
      const [years, setYears] = useState(30);
      const [fixedRatePct, setFixedRatePct] = useState(5.0);
      const [varStartPct, setVarStartPct] = useState(4.5);
      const [shockBps, setShockBps] = useState("0.02");   // +2% default
      const [shockYear, setShockYear] = useState(5);       // at year 5

      const P = Math.max(0, principal);
      const T = Math.max(1, years);
      const rFixed = Math.max(0, fixedRatePct)/100;
      const rVar0  = Math.max(0, varStartPct)/100;
      const shock  = Number(shockBps); // e.g., 0.02 for +2%

      // --- FIXED path ---
      const fixedPayment = useMemo(()=> monthlyPayment(P, rFixed, T), [P, rFixed, T]);
      const fixedTotalPaid = fixedPayment * Math.round(T*12);
      const fixedTotalInterest = fixedTotalPaid - P;

      // --- VARIABLE path with a single shock at shockYear (+shock to the rate) ---
      const shockMonth = clamp(Math.round(shockYear*12), 1, Math.round(T*12)-1);
      const varPay0 = useMemo(()=> monthlyPayment(P, rVar0, T), [P, rVar0, T]);
      const balAtShock = useMemo(()=> remainingBalance(P, rVar0, T, varPay0, shockMonth), [P, rVar0, T, varPay0, shockMonth]);
      const rVar1 = rVar0 + shock; // rate jumps at the shock

      const monthsTotal = Math.round(T*12);
      const monthsLeft = monthsTotal - shockMonth;
      const varPay1 = useMemo(()=> monthlyPayment(balAtShock, rVar1, monthsLeft/12), [balAtShock, rVar1, monthsLeft]);

      const varTotalPaid = varPay0*shockMonth + varPay1*monthsLeft;
      const varTotalInterest = varTotalPaid - P;

      // Chart data: monthly payments over time
      const fixedSeries = useMemo(()=> Array.from({length: monthsTotal}, ()=> fixedPayment), [fixedPayment, monthsTotal]);
      const varSeries = useMemo(()=> [
        ...Array.from({length: shockMonth}, ()=> varPay0),
        ...Array.from({length: monthsLeft}, ()=> varPay1)
      ], [varPay0, varPay1, shockMonth, monthsLeft]);

      const diffPaid = varTotalPaid - fixedTotalPaid;
      const warning =
        shock <= 0 ? "No rate shock selected; variable stays at its initial rate."
                   : `Variable rate increases by ${(shock*100).toFixed(1)}% at year ${shockYear}.`;

      return (
        <div className="min-h-screen bg-gray-50 max-w-6xl mx-auto px-4 py-8 space-y-6">
          <header className="space-y-2">
            <h1 className="text-2xl md:text-3xl font-bold">Station B: Fixed vs. Variable Interest</h1>
            <p className="text-gray-600 max-w-3xl">
              Compare a <strong>fixed-rate loan</strong> with a <strong>variable-rate loan</strong> that can jump at a chosen year.
              See how monthly payments and total costs change when rates rise.
            </p>
          </header>

          <Card title="Set Your Scenario">
            <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
              <NumberInput label="Loan Amount" value={principal} setValue={setPrincipal} step={1000} suffix="USD"/>
              <NumberInput label="Term" value={years} setValue={setYears} step={1} suffix="years"/>
              <NumberInput label="Fixed Rate" value={fixedRatePct} setValue={setFixedRatePct} step={0.125} suffix="% APR"/>
              <NumberInput label="Variable Start Rate" value={varStartPct} setValue={setVarStartPct} step={0.125} suffix="% APR"/>
              <Select
                label="Variable Rate Shock"
                value={shockBps}
                setValue={setShockBps}
                options={[
                  {value:"0.00", label:"None"},
                  {value:"0.01", label:"+1%"},
                  {value:"0.02", label:"+2%"},
                  {value:"0.03", label:"+3%"},
                  {value:"0.04", label:"+4%"},
                ]}
              />
              <Select
                label="Shock Year"
                value={String(shockYear)}
                setValue={v=>setShockYear(Number(v))}
                options={Array.from({length: T-1}, (_,i)=>({value:String(i+1), label:`Year ${i+1}`}))}
              />
            </div>
            <div className="mt-3 text-sm text-gray-600">{warning}</div>
          </Card>

          <div className="grid md:grid-cols-2 gap-6">
            <Card title="Fixed Loan">
              <ul className="text-sm space-y-2">
                <li>Monthly payment: <strong className="text-blue-700">{formatUSD(fixedPayment)}</strong></li>
                <li>Total paid (life of loan): <strong>{formatUSD(fixedTotalPaid)}</strong></li>
                <li>Total interest: <strong>{formatUSD(fixedTotalInterest)}</strong></li>
              </ul>
            </Card>

            <Card title="Variable Loan (with shock)">
              <ul className="text-sm space-y-2">
                <li>Payment before shock: <strong className="text-amber-700">{formatUSD(varPay0)}</strong> (first {shockMonth} months)</li>
                <li>Payment after shock: <strong className="text-amber-700">{formatUSD(varPay1)}</strong> (remaining {monthsLeft} months)</li>
                <li>Total paid (life of loan): <strong>{formatUSD(varTotalPaid)}</strong></li>
                <li>Total interest: <strong>{formatUSD(varTotalInterest)}</strong></li>
              </ul>
            </Card>
          </div>

          <Card title="What changed overall?">
            <div className="grid md:grid-cols-3 gap-4 text-sm">
              <div>
                <div className="text-gray-600">Variable vs. Fixed (Total Paid)</div>
                <div className={`text-xl font-semibold ${diffPaid>=0?'text-red-700':'text-green-700'}`}>
                  {diffPaid>=0? '+' : ''}{formatUSD(diffPaid)}
                </div>
              </div>
              <div>
                <div className="text-gray-600">Balance at shock (variable path)</div>
                <div className="text-xl font-semibold">{formatUSD(balAtShock)}</div>
              </div>
              <div className="col-span-1 md:col-span-1">
                <div className="text-gray-600">Interpretation</div>
                <div className="text-sm">
                  {shock>0
                    ? "When the rate jumps, the variable loan’s payment is recalculated on the remaining balance—often pushing monthly cost (and total paid) higher."
                    : "Without a shock, the variable loan stays at its starting rate; compare totals against the fixed loan."}
                </div>
              </div>
            </div>
          </Card>

          <ChartPanel monthsTotal={monthsTotal} fixedSeries={fixedSeries} varSeries={varSeries} shockMonth={shockMonth}/>

          <footer className="py-8 text-center text-xs text-gray-500">
            © {new Date().getFullYear()} Loan Lab — Station B
          </footer>
        </div>
      );
    }

    /*** Chart component (Chart.js) ***/
    function ChartPanel({monthsTotal, fixedSeries, varSeries, shockMonth}){
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      const labels = useMemo(()=> Array.from({length: monthsTotal}, (_,i)=> i+1), [monthsTotal]);

      useEffect(()=>{
        const ctx = canvasRef.current.getContext('2d');
        if(chartRef.current){ chartRef.current.destroy(); }
        chartRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Fixed Payment',
                data: fixedSeries,
                borderWidth: 2,
                tension: 0.2
              },
              {
                label: 'Variable Payment',
                data: varSeries,
                borderWidth: 2,
                borderDash: [6,4],
                tension: 0.2
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: {
                title: { display: true, text: 'Month' },
                ticks: { maxTicksLimit: 12 }
              },
              y: {
                title: { display: true, text: 'Monthly Payment (USD)' },
                beginAtZero: false
              }
            }
          }
        });
        return ()=> { if(chartRef.current){ chartRef.current.destroy(); } };
      }, [labels.join(','), fixedSeries.join(','), varSeries.join(',')]);

      return (
        <Card title="Monthly Payment Over Time (Fixed vs. Variable)">
          <div className="text-sm text-gray-600 mb-2">
            The vertical change in the dashed line shows the **rate shock** (variable payment jump) around month {shockMonth}.
          </div>
          <div className="bg-white rounded-xl overflow-hidden">
            <canvas ref={canvasRef} height="120"></canvas>
          </div>
        </Card>
      );
    }

    function App(){ return <StationB/>; }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
